{% extends 'base.html' %}

{% block title %}Roluri & Drepturi{% endblock %}

{% block content %}
<div class="container py-4">
  <h5 class="mb-3">Administrare roluri și permisiuni</h5>
  <div class="row g-4">
    <div class="col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-semibold">Grupuri (Roluri)</div>
        <div class="list-group list-group-flush">
          {% for g in groups %}
          <a class="list-group-item list-group-item-action {% if selected_group and selected_group.id == g.id %}active{% endif %}"
             href="?group={{ g.id }}">
            {{ g.name }}
            <span class="badge bg-secondary float-end">{{ g.permissions.count }}</span>
          </a>
          {% empty %}
          <div class="list-group-item text-muted">Niciun rol definit.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-semibold">Permisiuni pentru: {% if selected_group %}{{ selected_group.name }}{% else %}-{% endif %}</div>
        <div class="p-3" style="max-height: 520px; overflow: auto;">
          {% if selected_group %}
          <form method="post" action="{% url 'core:assign_roles' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_group_permissions">
            <input type="hidden" name="group_id" value="{{ selected_group.id }}">
            {% for group in grouped_permissions %}
            <div class="mb-3 border rounded">
              <div class="p-2 bg-light d-flex justify-content-between align-items-center">
                <span class="fw-semibold">{{ group.menu }}</span>
                <div class="small">
                  <a href="#" class="me-2" onclick="event.preventDefault(); checkSection(this, true)">selectează tot</a>
                  <a href="#" onclick="event.preventDefault(); checkSection(this, false)">deselectează</a>
                </div>
              </div>
              <div class="p-2 row g-2">
                {% for p in group.permissions %}
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="perm_ids" value="{{ p.id }}" id="perm_{{ p.id }}"
                           {% if p.id in assigned_perm_ids %}checked{% endif %}>
                    <label class="form-check-label" for="perm_{{ p.id }}">
                      <code>{{ p.content_type.model }}</code> • {{ p.codename }}
                    </label>
                  </div>
                </div>
                {% empty %}
                <div class="col-12 text-muted small">Fără permisiuni.</div>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
            <div class="d-flex justify-content-end">
              <button class="btn btn-primary">Salvează permisiunile</button>
            </div>
          </form>
          {% else %}
          <div class="text-muted">Selectează un rol din listă.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light fw-semibold">Asignare utilizatori la rol</div>
        <div class="p-3">
          <form method="post" action="{% url 'core:assign_roles' %}" class="row g-2 align-items-end">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_user_to_group">
            <div class="col-12">
              <label class="form-label small">Utilizator</label>
              <select class="form-control" name="user_id">
                {% for u in users %}
                <option value="{{ u.id }}">{{ u.username }} ({{ u.get_full_name }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12">
              <label class="form-label small">Rol</label>
              <select class="form-control" name="group_id">
                {% for g in groups %}
                <option value="{{ g.id }}" {% if selected_group and selected_group.id == g.id %}selected{% endif %}>{{ g.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 d-flex gap-2">
              <button class="btn btn-primary">Adaugă în rol</button>
              <button class="btn btn-outline-danger" name="action" value="remove_user_from_group">Elimină din rol</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function checkSection(anchor, value) {
  const section = anchor.closest('.mb-3');
  const inputs = section.querySelectorAll('input[type="checkbox"][name="perm_ids"]');
  inputs.forEach(i => i.checked = value);
}
</script>
{% endblock %}
