{% extends 'base.html' %}
{% load static schedule_extras %}

{% block title %}Orar pentru tipărire{% endblock %}

{% block extra_css %}
<style>
  @page { size: A4 landscape; margin: 12mm; }
  html, body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  /* Layout curat pentru print */
  .container-print { max-width: 100% !important; padding: 0 !important; }
  .print-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  .print-meta {
    color: #6c757d;
    font-size: 0.95rem;
  }
  .day-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
    page-break-inside: avoid;
  }
  .day-title {
    font-weight: 700;
    margin-bottom: 0.75rem;
  }
  .day-table {
    width: 100%;
    border-collapse: collapse;
  }
  .day-table th, .day-table td {
    border: 1px solid #dee2e6;
    padding: 0.5rem 0.6rem;
    vertical-align: top;
    font-size: 0.95rem;
  }
  .day-table thead th {
    background: #f8f9fa;
    font-weight: 600;
    text-align: left;
  }
  /* Tabel compact pe o singură pagină */
  .compact-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    font-size: 0.85rem;
  }
  .compact-table th, .compact-table td {
    border: 1px solid #dee2e6;
    padding: 0.3rem 0.4rem;
    vertical-align: top;
    word-wrap: break-word;
  }
  .compact-table thead th {
    background: #f8f9fa;
    text-align: center;
    font-weight: 700;
  }
  .col-ora { width: 60px; }
  .col-zi { width: auto; }
  .entry-box { margin-bottom: 0.25rem; border-left: 4px solid #aaa; padding-left: 6px; }
  .entry-title { font-weight: 600; }
  .entry-sub { color: #6c757d; font-size: 0.8rem; }
  .no-print {
    display: inline-block;
  }
  @media print {
    .no-print { display: none !important; }
    .navbar, .footer, .schedule-filters, .calendar-header { display: none !important; }
    body { background: white !important; margin: 0; }
    .container-print { width: 100%; margin: 0; max-width: 100% !important; padding: 0 !important; }
    .compact-table { font-size: 0.8rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container container-print py-4">
  <div class="print-header">
    <div>
      <h3 class="mb-1">Orar școlar</h3>
      <div class="print-meta">
        Data tipăririi: {{ print_date|date:"d.m.Y" }}
        {% if profile %}
          • Start: {{ profile.ore_start|time:"H:i" }} • Durata oră: {{ profile.durata_ora }} min • Pauză: {{ profile.durata_pauza }} min • Max/zi: {{ profile.nr_ore_pe_zi }}
        {% endif %}
      </div>
    </div>
    <div>
      <button type="button" class="btn btn-outline-secondary no-print" onclick="window.print()">
        <i class="fas fa-print me-1"></i>Printează
      </button>
      <button type="button" id="btnExportPdf" class="btn btn-primary no-print ms-2">
        <i class="fas fa-file-pdf me-1"></i>Exportă PDF
      </button>
    </div>
  </div>

  <!-- Tabel compact: rânduri = ore (1..max_hours), coloane = zile (Luni..Vineri) -->
  <div id="printArea">
  <table class="compact-table">
    <thead>
      <tr>
        <th class="col-ora">Ora</th>
        {% for day_name in weekdays %}
          <th class="col-zi">{{ day_name }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for idx in hour_slots %}
      <tr>
        <th class="text-center">{{ idx }}</th>
        {% for day_name in weekdays %}
        <td>
          {% with day_entries=schedule_data|get_item:day_name %}
            {% for entry in day_entries %}
              {% if entry.numar_ora == idx %}
              <div class="entry-box" style="border-left-color: {{ entry.subject.culoare }};">
                <div class="entry-title">{{ entry.subject.nume }}</div>
                <div class="entry-sub">
                  {% if entry.ora_inceput and entry.ora_sfarsit %}
                    {{ entry.ora_inceput|time:"H:i" }}–{{ entry.ora_sfarsit|time:"H:i" }}
                  {% endif %}
                  {% if entry.sala %} • Sala {{ entry.sala }}{% endif %}
                </div>
                {% if entry.note %}<div class="entry-sub">{{ entry.note }}</div>{% endif %}
              </div>
              {% endif %}
            {% endfor %}
          {% endwith %}
        </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIP7LQ2nQnB5yM8b1rqJxw0g4RqQ0n4mQd4Vh6nXR3ZrT8mJc6x2x2rYkGxsHqVnH0G8v3No89c8E3hGfP4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
document.getElementById('btnExportPdf')?.addEventListener('click', function() {
  const runExport = function() {
    const element = document.getElementById('printArea');
    const opt = {
      margin: [5, 8, 5, 8],
      filename: 'orar-scolar.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
    };
    window.html2pdf().set(opt).from(element).save();
  };

  if (window.html2pdf) {
    runExport();
  } else {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js';
    s.onload = runExport;
    s.onerror = function() {
      alert('Nu s-a putut încărca librăria PDF. Încearcă din nou.');
    };
    document.body.appendChild(s);
  }
});
</script>
{% endblock %}


