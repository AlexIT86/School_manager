{% extends 'base.html' %}
{% block title %}Chat - Inbox{% endblock %}
{% block content %}
<script>window.DISABLE_TOASTS = true; document.addEventListener('DOMContentLoaded',()=>{ document.body.dataset.noToasts='1';});</script>
<div class="container py-4">
  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <h2 class="h6 mb-2"><i class="fas fa-comments me-2 text-primary"></i>Conversații</h2>
      <div class="list-group">
    {% for c in conversations %}
      <a href="{% url 'chat:conversation' c.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
        <span>
          {% if c.title %}{{ c.title }}{% else %}
            {% for p in c.participants.all %}{% if p != request.user %}{{ p.username }}{% if not forloop.last %}, {% endif %}{% endif %}{% endfor %}
          {% endif %}
        </span>
        <i class="fas fa-chevron-right text-muted"></i>
      </a>
    {% empty %}
      <div class="text-muted">Nu ai conversații încă.</div>
    {% endfor %}
      </div>
    </div>
    <div class="col-md-6">
      <h2 class="h6 mb-2"><i class="fas fa-user-friends me-2 text-secondary"></i>Utilizatori</h2>
      <div class="list-group">
        {% for u in all_users %}
        <div class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ u.username }}</strong>
            {% if u.first_name or u.last_name %}
              <small class="text-muted"> • {{ u.get_full_name }}</small>
            {% endif %}
          </div>
          <div class="d-flex align-items-center gap-2">
            {% if u.id in user_ids_online %}
              <span class="badge bg-success">online</span>
            {% else %}
              <span class="badge bg-secondary">offline</span>
            {% endif %}
            <button class="btn btn-sm btn-outline-primary" onclick="startConversationWith('{{ u.username }}')">Mesaj</button>
          </div>
        </div>
        {% empty %}
        <div class="text-muted">Niciun utilizator.</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
function getCookie(name){
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return '';
}
function startConversation(){
  const u = document.getElementById('startUsername').value.trim();
  if(!u){ return; }
  fetch('{% url 'chat:start' %}', {
    method:'POST',
    headers:{'X-CSRFToken': getCookie('csrftoken'), 'Content-Type':'application/x-www-form-urlencoded'},
    body: new URLSearchParams({username:u})
  }).then(r=>r.json()).then(d=>{
    if(d.success){ window.location.href = `/chat/${d.conversation_id}/`; }
    else { alert(d.error||'Eroare'); }
  });
}

function startConversationWith(username){
  fetch('{% url 'chat:start' %}', {
    method:'POST',
    headers:{'X-CSRFToken': getCookie('csrftoken'), 'Content-Type':'application/x-www-form-urlencoded'},
    body: new URLSearchParams({username})
  }).then(r=>r.json()).then(d=>{
    if(d.success){ window.location.href = `/chat/${d.conversation_id}/`; }
  });
}
</script>
{% endblock %}
{% endblock %}


